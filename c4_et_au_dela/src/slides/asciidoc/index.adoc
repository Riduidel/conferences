:icons: font
:revealjs_progress: true
:revealjs_previewLinks: true
:revealjs_mouseWheel: true
:revealjs_history: true
:revealjs_preloadIframes: true
:revealjs_plugin_notes: disabled
:customcss: custom.css
:source-highlighter: highlightjs

[%notitle]
= C4 et au-del√†, documenter agilement une architecture
:sectnums!:

[NOTE.speaker]
--
Checklist avant conf√©rence

. Ouvrir le dossier `C:\Users\nicolas-delsaux\Documents\Zenika\conferences\c4_et_au_dela\example\architecture` dans VSCode (il contient les snippets)
. D√©marrer structurizr-lite `docker run --rm --name structurizr-lite -d -p 18080:8080 -v %CD%/c4_et_au_dela/example/architecture:/usr/local/structurizr structurizr/lite`
. Parcourir la pr√©sentation une fois en warmup pour tout d√©marrer correctement
. Configurer le workspace VSCode d'exemple pour avoir les retours √† la ligne
--

[%notitle, background-iframe="https://manifesteagile.fr/#valeurs"]
== Ca ne sert √† rien, on est agiles

[NOTE.speaker]
--
Pourquoi documenter quand le manifeste agile dit clairement qu'il faut privil√©gier

[quote, https://manifesteagile.fr/#valeurs]
> Des solutions op√©rationnelles, de pr√©f√©rence √† une documentation exhaustive

Pr√©cis√©ment parce que le manifeste parle de privil√©gier, et pas d'√©liminer.
Et dans cette pr√©sentation, on va pr√©cis√©ment parler de moyens de produire plus de documentation avec moins de travail.
--

[%notitle]
== Qui suis-je ?

Nicolas Delsaux / @riduidel on https://twitter.com/riduidel[icon:twitter[]] / https://github.com/riduidel[icon:github[]] / https://stackexchange.com/users/8620[icon:stack-overflow[]]

D√©veloppeur Java depuis l'an 2000

Architecte de solutions/syst√®mes depuis 2015

image::images/zenika.png[height=100]

[NOTE.speaker]
--
En tant que d√©veloppeur et architecte, je me suis beaucoup int√©ress√© √† la question de la documentation d'architecture.
--

== Pourquoi documenter l'architecture ?

++++
<div align=center>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Because the code is the truth, but not the whole truth.</p>&mdash; Grady Booch (@Grady_Booch) <a href="https://twitter.com/Grady_Booch/status/1253062981283221504?ref_src=twsrc%5Etfw">April 22, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
</div>
++++

[NOTE.speaker]
--
On pourrait parler de politique dans les entreprises,
de syst√®mes socio-techniques, etc...
Mais en fait, c'est tellement plus simple de dire que si le code explique correctement le "comment" d'un logiciel,
il ne r√©pond pas √† quelques autres questions
--

=== A quelles questions r√©pondre ?

* Qui ?
* Quand ?
* Quoi ?
* [line-through]#O√π ?#
* Pourquoi ?
* [line-through]#Comment ?#

[NOTE.speaker]
--
J'ignorais que https://fr.wikipedia.org/wiki/QQOQCCP[ces questions] provenaient de la m√©thode aristoc√©licienne.
En revanche, je connais l'acronyme des 5W et son usage dans le journalisme.
Et je trouve int√©ressant de se poser la m√™me question √† propos d'un syst√®me logiciel, pr√©cis√©ment parce qu'il s'agit d'un artefact ayant une vie impliquant des personnes aux profils divers.
--
=== Comment r√©pondre √† ces questions ?

image::https://media.giphy.com/media/j3cIiYP90ci1QgyWAk/giphy.gif[]

[NOTE.speaker]
--
Bien s√ªr qu'il faut communiquer, mais via quels moyens ?
--

[.columns]
[%notitle]
=== Some poor solutions (we all use)

[.column]
* **Outil d√©di√©**
** Complet icon:check-circle[role=green]
** Difficile √† exporter icon:times-circle[role=red]
** Difficile de monter en comp√©tence icon:times-circle[role=red]

[.column]
* **Tableau blanc** (physique ou virtuel)
** Facile √† utiliser icon:check-circle[role=green]
** Aucune coh√©rence icon:times-circle[role=red]
** Dur√©e de vie inconnue icon:times-circle[role=red]

[NOTE.speaker]
--
La plupart du temps, les architectes disposent d'un spectre d'outils allant du tableau blanc, qu'il soit physique ou virtuel (draw.io, Miro, Mural, ...), aux outils d√©di√©s (Archi, les outils UML, ...).
Ces outils ont √©videment des avantages dif√©rents, associ√©s √† des inconv√©nients diff√©rents.
Sans doute parce qu'ils s'adressent √† des publics *tr√®s* diff√©rents, dans des phases diff√©rentes du cycle de vie de l'application.
Et quand on regarde, il semble √©vident qu'il puisse exister un outillage entre ces deux extr√™mes, disposant de qualit√©s diff√©rentes, pour fournir un outil utile aux diff√©rents membres de l'√©quipe.
--

[.columns]
== C4

[.column]
image::images/simon_brown.png[height=400]

[.column]
* Context, Containers, Components, Code
* La m√©taphore classique de la carte
* Imagin√© par Simon Brown (https://twitter.com/riduidel[icon:twitter[] @simonbrown])

[NOTE.speaker]
--
Le concept de C4 est tr√®s simple, et c'est la raison pour laquelle il est aussi utile dans une p√©riode de simplification.
On part du contexte du syst√®me pour arriver au code en passant par deux √©tages interm√©diaires.
Simon Brown habite Jersey, et du coup il fait d'habitude une pr√©sentation qui emm√®ne les gens jusque sur son √Æle.
Aujourd'hui, on est √† Grenoble, on va donc plut√¥t vous emmener jusqu'ici ...
--

[%notitle, background-color="white"]
=== Un exemple rapide ?

image::images/spring-pet-clinic-github.png[size=cover]

[NOTE.speaker]
--
**Demander qui conna√Æt PetClinic**

Histoire de se fixer les id√©es, on va partir d'un projet plut√¥t connu dans le monde Java : icon:github[set=fab] https://github.com/spring-projects/spring-petclinic#readme[spring pet clinic].
C'est un exemple d'application Spring assez simple qui leur permet d'exposer les diff√©rentes fonctionnalit√©s
--

=== Context

[cols="2", width="100%", frame=none, grid=none]
|===
|
image:images/openstreetmap-carte-france.png[width="600", height="600"]
|
+++
<iframe id="pet-clinic-context" data-src="https://structurizr.com/static/assets/structurizr-1-diagrams.html#context" width="800" height="600"  ></iframe>
+++
|===

[NOTE.speaker]
--
Pr√©sente l‚Äôapplication dans son contexte

* Liste des utilisateurs (√ßa n‚Äôest pas un hasard si √ßa ressemble aux user stories)
* Liste des syst√®mes interconnect√©s (M√™me √† travers un API Manager ou  Kafka, n'oubliez pas d'indiquer le type d'interconnexion)

En revanche, on ne s'int√©resse pas aux technologies, ni aux protocoles de communication.

Au passage, notez que si dans le diagramme on s'int√©resse aux interconnexions, 
c'est √©galement vrai sur la carte : on voit d√©ja les autoroutes, et on verra tr√®s vite les lignes de chemin de fer.
--


=== Containers

[cols="2", width="100%", frame=none, grid=none]
|===
|
image:images/openstreetmap-carte-savoie.png[width="600", height="600"]
|
+++
<iframe id="pet-clinic-containers" data-src="https://structurizr.com/static/assets/structurizr-1-diagrams.html#containers" width="800" height="600"  ></iframe>
+++
|===

=== Containers

* Les conteneurs ne sont pas forc√©ment des conteneurs Docker (par exemple dans un monolithe)
* Les conteneurs ne sont pas for√©ment des modules Maven/Gradle/... (par exemple dans des microservices)

* Les conteneurs sont des √©l√©ments signifiants de l'architecture. Et **√ßa d√©pend fortement de l'architecture**

[NOTE.speaker]
--
Dans la d√©finition, Simon Brown indique

[quote, Simon Brown]
Essentially, a container is a separately runnable/deployable unit (e.g. a separate process space) that executes code or stores data.

En v√©rit√©, √ßa se discute, et il peut √™tre parfois int√©ressant 
de s√©parer plusieurs conteneurs tournant dans le m√™me process (typiquement dans un monolithe significatif)
--


[%notitle]
=== Components
[cols="2", width="100%", frame=none, grid=none]
|===
|
image:images/openstreetmap-carte-grenoble.png[width="600", height="600"]
|
+++
<iframe id="pet-clinic-components" data-src="https://structurizr.com/static/assets/structurizr-1-diagrams.html#components" width="800" height="600"  ></iframe>
+++
|===

=== Components

Si votre framework utilise des composants, c'est cool !

image:images/spring-3-logo-png-transparent.png[height=50]
image:images/javaee.png[height=100]

image:images/vue-js.png[height=50]
image:images/reactjs.png[height=50]
image:images/angular.png[height=50]


[%notitle]
=== Code

[cols="2", width="100%", frame=none, grid=none]
|===
|
image:images/openstreetmap-carte-gare.png[width="600", height="600"]
|

image:images/spring-OwnerController.png[]

|===

[NOTE.speaker]
--
J'ai mis ici un lien direct vers le code.
Mais il peut √™tre int√©ressant de documenter plus pr√©cis√©ment 
les interactions entre les diff√©rents √©l√©ments qui forment le composant (dans un framework MVC, par exemple).
--

[%notitle]
=== C'est bien, mais

image::https://media.giphy.com/media/YoWYbUDeJK6Telrvzs/giphy.gif[]

[%step]
* Les diagrammes peuvent √™tre inconsistants
* Les diagrammes ne peuvent pas r√©pondre √† toutes les questions
* Les diagrammes peuvent ne pas √™tre √† jour

[NOTE.speaker]
--
On va d'abord se concentrer sur le premier point (sinon je ne l'aurais pas mis en premier).
--

== Comment rendre les diagrammes consistants

[%step]
En les basant sur un mod√®le !

[%notitle, background-iframe="https://c4model.com/#Tooling"]
=== Heureusement, il y a de l'outillage !


[NOTE.speaker]
--
Sur le site de https://c4model.com/#Tooling[C4Model], on trouve tout un tas d'outils permettant de baser nos diagrammes sur un mod√®le, et donc d'apporter de la consistance.
On va √©videment parler de Structurizr
--

[%notitle, background-iframe="https://structurizr.com/"]
=== Structurizr

[NOTE.speaker]
--
Le fait que C4 ne soit qu'un dessin est un inconv√©nient connu de son cr√©ateur, Simon Brown, qui a d√©velopp√© une suite d'outils, collectivement appel√©s Structurizr.
On a donc 
* Un DSL bas√© sur Kotlin (qu'on va tout de suite tester)
* Un outil d'affichage des diagrammes en local (structurizr-lite) et en SaaS (Structurizr)
* Des librairies permettant de cr√©er des mod√®les d'architecture dans un certain nombre de langages
--

[%notitle]
=== Structurizr DSL

image::images/structurizr_dsl.png[[canvas,size=contain]

[%notitle]
=== D√©but de la d√©mo

image::https://media.giphy.com/media/Y1XrxoBKZHTHeky1Wy/giphy.gif[]

[NOTE.speaker]
--
Dans cette d√©mo, on va cr√©er un fichier `structurizr.dsl` et y d√©crire un mod√®le d'architecture incluant des conteneurs, des composants et des vues diverses.
--

ifndef::environment-reveal[]

=== Initialisation

Avant tout, d√©marrer structurizr-lite dans un dossier dans lequel se trouve un fichier `workspace.dsl`

[source]
----
docker run --rm --name structurizr-lite -d -p 18080:8080 -v %CD%/c4_et_au_dela/example/architecture:/usr/local/structurizr structurizr/lite
----

=== Cr√©ation du workspace

[source]
----
workspace {
    model {
    }

    views {
       styles {
       }

       theme default
       branding {
           logo https://snowcamp.io/img/alpes-snow-full-illustration.webp
       }
    }
}
----

Ici, on cr√©e le workspace, et on lui ajoute imm√©diatement les deux grandes parties : le mod√®le et les vues.
Notez que le tag branding permet d'ajouter facilement un logo d'entreprise aux diagrammes.

==== Ajout du contexte

[source]
----
    model {
        owner = person "Owner" "Pet Owner"
        vet = person "Veterinary" "Veterinary working at pet clinic"
        petclinic = softwareSystem "Pet Clinic" "Allows employees to view and manage information regarding the veterinarians, the clients, and their pets." {
        }

        owner -> petclinic "Book an apointment"
        vet -> petclinic "Check apointments"

        // TODO Add deployment model with 06_deployment_mode
    }
----

Sans contexte syst√®me, on ne va pas faire grand chose.
On ajoute donc un syst√®me, et des √©l√©ments connect√©s.
On a ici que des personnes, mais on pourrait aussi avoir d'autres syst√®mes.

==== Et d'une premi√®re vue

Et √©videment, pour voir notre contexte, on cr√©e une vue de ce contexte.

[source]
----
    views {
       styles {
            systemLandscape landscape {
                include *
                autoLayout
            }
       }

       theme default
    }
----

La vue est tr√®s facile √† d√©crire puisqu'on se contente de r√©f√©rencer les √©l√©ments du mod√®le et d'indiquer qu'on fait un layout automatique.
structurizr permet dans l'interface web des layouts manuels, qu'on ne verra pas dans cette pr√©sentation.

==== Ajout des conteneurs

[source]
----
        petclinic = softwareSystem "Pet Clinic" "Allows employees to view and manage information regarding the veterinarians, the clients, and their pets." {
            db = container "Database" "Stores informations regarding the veterinarians, the clients, and their pets." "RDBMS"
            webapp = container "Web Application" "Allows employees to view and manage information regarding the veterinarians, the clients, and their pets." "Java, Spring" {
               // TODO add components with 08_components_model",
            }
            webapp -> db "Read and writes informations"
            owner -> webapp
            vet -> webapp
        }
----

Maintenant qu'on a un syst√®me, on peut d√©tailler son contenu.
Et comme pour le syst√®me, on voit qu'il est assez simple de d√©clarer les diff√©rents conteneurs et leurs interactions.

==== Et de leur vue

[source]
----
    views {
        styles {
             systemLandscape landscape {
                 include *
                 autoLayout
             }
        }
        container petClinic {
            include *
            autoLayout
        }

       theme default
    }
----

Comme pour le syst√®me, la d√©claration de la vue est assez simple

==== Petit d√©tour par le d√©ploiement
Avant de plonger dans les composants de notre application, faisons un petit d√©tour par les d√©ploiements.
Parce que maintenant qu'on conna√Æt les conteneurs, il est utile de voir comment ces conteneurs sont d√©ploy√©s dans les diff√©rents environnements.

[source]
----
model {
    // D√©claration des syst√®mes
    dev = deploymentEnvironment "dev" {
        deploymentNode "Developer laptop" {
            deploymentNode "Docker container - web server" {
                deploymentNode "Tomcat" {
                    containerInstance webapp
                }
            }
            deploymentNode "Docker container - DB" {
                deploymentNode "Database server" {
                    containerInstance db
                }
            }
        }
    }
}
----
Concernant le d√©ploiement, il faut noter qu'on utilise un tage g√©n√©rique `deploymentNode` pour toutes les √©tapes du d√©ploiement.
C'est moins pr√©cis, mais bien plus adaptable √† des contextes variables.
Et le d√©poiement est variable : 
on peut avoir plus ou  moins d'instances,
on peut vouloir plus ou moins de pr√©cision dans la description des machines et syst√®mes de conteneurs,
bref, c'est un domaine complexe et riche qui impose plus d'adaptabilit√©.

==== Vue du d√©ploiement

[source]
----
    views {
        // ...
        container petClinic {
            include *
            autoLayout
        }
        deployment * dev "Dev_machine" "Deployment of pet clinic on dev machine" {
            include *
            autoLayout
        }

       theme default
    }
----

==== Passons aux composants

D√©clarer l'ensemble des composants est franchement fastidieux :
il faut instancier chacun d'entre eux et les relier √† toutes leurs d√©pendances.
Plut√¥t que de le faire via un dsl, on va le faire en utilisant un composant additionnel de structurizr : structurizr-spring.

En fait, avec Structurizr, on peut marrier les approches, 
c'est-√†-dire commencer avec le DSL avant de basculer, pour des usages plus techniques, sur du code.

===== Charger le JSON
En fait, le fichier workplace.dsl est transform√© en fichier JSON avant d'√™tre charg√© dans structurizr-lite.
On peut donc charger ce JSON avec le lecteur appropri√© avant de le manipuler

[source;java]
----
include::../../../example/architecture/src/main/java/com/zenika/conference/c4/Structurizr.java[lines=67..72]
----

Cette m√©thode nous permet de lire le fichier JSON pour en tirer un objet `Worspace` offrant en Java les m√™mes possibilit√©s que celui disponible dans le `workspace.dsl`.

==== Etendre le mod√®le avec de l'analyse de code
Et maintenant vient la partie o√π on scanne les classes disponibles dans Spring PetClinic

[source;java]
----
include::../../../example/architecture/src/main/java/com/zenika/conference/c4/Structurizr.java[lines=34..47]
----

==== Ajouter une vue en Java

Il faut maintenant cr√©er la vue des composants

[source;java]
----
include::../../../example/architecture/src/main/java/com/zenika/conference/c4/Structurizr.java[lines=49..51]
----

==== Ecrire les vues

Et plut√¥t que d'√©crire les vues dans structurizr, pourquoi ne pas g√©n√©rer des diagrammes gr√¢ce √† PlantUML ?

[source;java]
----
include::../../../example/architecture/src/main/java/com/zenika/conference/c4/Structurizr.java[lines=53..57]
----


endif::[]

[%notitle]
== C'est bien, mais

image::https://media.giphy.com/media/YoWYbUDeJK6Telrvzs/giphy.gif[]

[%step]
* Les diagrammes ne peuvent pas r√©pondre √† toutes les questions
* Les diagrammes peuvent ne pas √™tre √† jour

[NOTE.speaker]
--
Aucune carte n'a emp√™ch√© quelqu'un de se perdre.
Parce qu'une carte explique la g√©ographie, et pas l'histoire (et les deux se m√©langent souvent).
--

== Comment raconter l'histoire ?

[%notitle]
=== Avec un bon plan

image::images/agile-architecture-documentation.png[background, size=cover]

[NOTE.speaker]
--
C'est un plan tr√®s complet, et utilisable quelquesoit votre mode de documentation
(Word/Google Docs, Wiki, Site g√©n√©r√© depuis Markdown/Asciidoc).
Et c'est cool, parce que √ßa permet de rapprocher la documentation du code.
--

=== C'est bien, mais

image::https://media.giphy.com/media/fatcd1PnHPTDW/giphy.gif[]

* Les diagrammes peuvent ne pas √™tre √† jour

[.columns]
== Et si ...

[.column]
image::images/et_si_exemple.png[]

[.column]
[%step]
* On utilisait le principe DRY
* Et le fait que le mod√®le Structurizr soit exprim√© par du code

[NOTE.speaker]
--
On sait qu'on peut mettre de la g√©n√©ration de documentation et de diagramme dans du code.
Alors pourquoi ne pas faire de la documentation d'architecture un module de l'application ?
--

=== Les d√©veloppeurs sont aussi des architectes !

++++
<div align=center>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I believe in storing developer-oriented docs in the repo.<br><br>1. No discovery issues. It‚Äôs in the repo. üîé<br>2. Easily navigate between the docs and the code it‚Äôs describing. üß≠<br>3. No access concerns. Repo access = doc access. ‚õîÔ∏è<br>4. The docs are version controlled üí™</p>&mdash; Cory House (@housecor) <a href="https://twitter.com/housecor/status/1487095280763817990?ref_src=twsrc%5Etfw">January 28, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
</div>
++++

[.columns]
=== Nous avons d√©ja les infos

[.column]
[%step]
* O√π sont nos conteneurs ?
** Dans le https://maven.apache.org/ref/3.6.3/maven-model/[maven-model] ? Ou dans un SCM (https://github-api.kohsuke.org/[github-api] ou https://github.com/gitlab4j/gitlab4j-api[gitlab4j-api])
* O√π sont nos composants ?
** Dans maven ? Structurizr

[.column]
[%step]
* Comment est configur√© notre d√©ploiement ?
** Dans Kubernetes (avec  https://github.com/fabric8io/kubernetes-client[fabric8 Kubernetes Client]) ? Ou dans Vault (avec https://bettercloud.github.io/vault-java-driver/[Vault Java Driver])

=== Avec √ßa, tout est possible !

++++
<div align=center>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">As an example, I&#39;ve already used Hashicorp Vault Java client, GitHub client API and Kubernetes client to populate my model from informations already existing, so I guess it&#39;s possible to get users/containers/components from a reference system ...</p>&mdash; Nicolas Delsaux (@riduidel) <a href="https://twitter.com/riduidel/status/1280395424654901248?ref_src=twsrc%5Etfw">July 7, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
</div>
++++

== Merci !

image::https://media.giphy.com/media/1sMH6m5alWauk/giphy.gif[width=200%]

[.columns]
== R√©f√©rences

[.column]
Donnez votre avis sur roti.express !
image:images/url_roti.express.png[width=300]

[.column]
* https://www.c4model.com[C4Model]
* https://www.structurizr.com[Structurizr]
* https://github.com/structurizr/java-extensions/blob/master/docs/spring-petclinic.md[Structurizr appliqu√© √† Spring Pet Clinic]
* Slides disponibles sur https://github.com/Riduidel/conferences/c4_et_au-dela/src/slides/asciidoc

=== Si vous voulez les slides

image::images/qr_code_slides.png[]

